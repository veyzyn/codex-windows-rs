name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  check:
    name: Check (windows-latest)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Format check
        run: cargo fmt --all -- --check

      - name: Cargo check
        run: cargo check --locked

      - name: Clippy
        run: cargo clippy --locked --all-targets -- -D warnings

      - name: Tests
        run: cargo test --locked

  ci-release:
    name: CI Auto Release
    needs: check
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: windows-latest
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release --locked

      - name: Prepare release assets
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          Copy-Item target\release\codex-launcher.exe dist\codex-launcher.exe -Force
          $hash = (Get-FileHash dist\codex-launcher.exe -Algorithm SHA256).Hash.ToLower()
          "sha256  codex-launcher.exe  $hash" | Set-Content -Path dist\codex-launcher.sha256

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            dist/codex-launcher.exe
            dist/codex-launcher.sha256

      - name: Publish CI release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ci-${{ github.sha }}
          name: CI build ${{ github.sha }}
          prerelease: false
          make_latest: false
          files: |
            dist/codex-launcher.exe
            dist/codex-launcher.sha256
